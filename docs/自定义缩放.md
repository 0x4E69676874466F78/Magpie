# 自定义缩放

本文档指导您如何定义自己的缩放模式。

Magpie启动时会在所在目录搜索ScaleModels.json，如果未找到则会创建一个默认的。默认的ScaleModels.json内容如下：

```json
[
  {
    "name": "通用（Lanczos）",
    "model": [
      {
        "effect": "scale",
        "type": "lanczos6",
        "scale": [ 0, 0 ],
        "ARStrength": 0.7
      },
      {
        "effect": "sharpen",
        "type": "adaptive",
        "curveHeight": 0.6
      },
      {
        "effect": "sharpen",
        "type": "builtIn",
        "sharpness": 1,
        "threshold": 0.3
      }
    ]
  },
  {
    "name": "动漫 2x（Anime4K）",
    "model": [
      {
        "effect": "scale",
        "type": "Anime4K",
        "curveHeight": 0.3,
        "useDenoiseVersion": true
      },
      {
        "effect": "scale",
        "type": "mitchell",
        "scale": [ 0, 0 ]
      }
    ]
  },
  ...（省略）
]
```

ScaleModels.json的根元素是一个数组，其中的每个成员都是一个缩放模型。name属性是显示的名字，model属性是缩放模型的定义，缩放模型由一系列的effect堆叠而成，Magpie在缩放时会逐个应用这些effect。

effect分为两大类，scale和sharpen。type属性定义了子类型，Magpie支持数种scale和sharpen效果，不同的子类型有着不同的参数。

### 缩放效果

Magpie支持的缩放效果有：

1. Anime4K：[Anime4K](https://github.com/bloc97/Anime4K) v3.1 的移植，支持降噪变体。内置了自适应锐化，可以产生更好的视觉效果。固定的将输入放大至两倍。
   * 参数
     * curveHeight：自适应锐化强度。0表示不锐化，否则必须为正数，一般在0.3~2.0之间。默认值为0。
     * useDenoiseVersion：使用降噪版本的Anime4K，在有轻微噪点的情况下表现良好，因此推荐使用。默认值为false。
4. jinc2：使用jinc算法缩放输入。
   * 参数
     * scale：缩放比例，值必须是有两个元素的数组，分别指定长和高的缩放比例。如果是[0, 0]，则等比缩放到屏幕能容纳的最大大小。默认值为 [1,1]。
     * windowSinc：值越小图像越清晰，但会有锯齿。必须大于零。默认值为0.5。
     * sinc：值越大线条越锐利，但会产生抖动。必须大于零。默认值为0.825。
     * ARStrength：抗震铃强度。值越大抗震铃效果越好，但图像越模糊。必须在0到1之间。默认值为0.5。
3. mitchell：使用Mitchell-Netravali算法缩放输入。用于缩小时效果最佳。
   * 参数
     * scale：缩放比例，值必须是有两个元素的数组，分别指定长和高的缩放比例。如果是[0, 0]，则等比缩放到屏幕能容纳的最大大小。默认值为 [1,1]。
     * useSharperVersion：生成更锐利的图像，可能有更好的视觉效果。默认值为false。
4. HQBicubic：使用Direct2D内置的high quality cubic算法缩放输入。缩小图像时，首先使用可变大小的高质量三次核进行预缩放，然后进行三次插值。不推荐使用，因为缩小图像时mitchell已足够好，而且快的多。
   * 参数
     * scale：缩放比例，值必须是有两个元素的数组，分别指定长和高的缩放比例。如果是[0, 0]，则等比缩放到屏幕能容纳的最大大小。默认值为 [1,1]。
     * sharpness：值越大图像越锐利。必须在0到1之间。默认值为0。
5. lanczos6：使用Lanczos算法缩放输入。
   * 参数
     * scale：缩放比例，值必须是有两个元素的数组，分别指定长和高的缩放比例。如果是[0, 0]，则等比缩放到屏幕能容纳的最大大小。默认值为 [1,1]。
     * ARStrength：抗震铃强度。值越大抗震铃效果越好，但图像越模糊。必须在0到1之间。默认值为0.5。
6. pixel：将图像中每个像素进行整数倍放大，例如放大到2x2或3x3。可以完整保留原始图像的信息，但只能放大到整数倍。适用于输入图像较小的情况。
   * 参数
     * scale：缩放比例，和其他缩放算法不同，此值必须是正整数，因为图像尺寸只能等比例整数倍放大。默认值为1。

### 锐化效果

Magpie支持的锐化效果有：

1. adaptive：使用自适应锐化算法锐化输入。此算法着重于锐化图像中的模糊边缘，因此相比一般的锐化算法噪点、振铃和条纹更少。
   * 参数
     * curveHeight：锐化强度。必须大于零，一般在0.3~2.0之间。默认值为0.3。
2. builtIn：使用Direct2D内置的锐化算法锐化输入。
   * 参数
     * sharpness：锐化强度。必须在0~10之间。默认值为0。
     * threshold：锐化阈值。必须在0~1之间。默认值为0。

### 示例

预置的Anime4K缩放有2x和4x两种，分别适用于2倍以内的放大和4倍以内的放大。现在假设我需要一个接近3x的放大，且不能使用4x版本（可能是因为性能的限制，因为4x使用了两次Anime4K）。

思路是首先使用Anime4K将图像放大至两倍，然后使用Lanczos放大至适合屏幕，最后进行锐化，这是执行Lanczos后推荐的操作。

```json
{
    "name": "动漫 3x",
    "model": [
      {
        "effect": "scale",
        "type": "Anime4K",
        "curveHeight": 0.3
      },
      {
        "effect": "scale",
        "type": "lanczos6",
        "scale": [ 0, 0 ]
      },
      {
        "effect": "sharpen",
        "type": "adaptive",
        "curveHeight": 0.5
      }
    ]
}
```

几个需要注意的地方：

1. Anime4K没使用降噪版本，在没有噪点时可以稍微提高图像质量。
2. 共进行了两次锐化，第一次在Anime4K内部，为了提高Anime4K的输出质量；第二次在Lanczos之后，是为了减少Lanczos放大后引入的模糊。
3. 比起内置的锐化，自适应锐化在大多数场合表现的更好，但也有不如人意的时候。为了综合二者的优点，可以在自适应锐化后再稍微进行普通锐化，就像预置的“通用”缩放里所做的。